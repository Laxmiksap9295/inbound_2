var oThat;sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/BusyDialog","sap/m/MessageToast","sap/ui/core/Fragment"],function(e,t,a,n,r,l,i,s){"use strict";return e.extend("ZGT_MM_INBOUND.controller.Operational_Tat",{onInit:function(){oThat=this;this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.getRoute("OperationalTat").attachMatched(this._onRouteMatched,this);this.BusyDialog=new l;var e=new t({TruckInVisible:true,PreQualVisible:true,UnloadingVisible:false,PreQualExpVisible:false,LoadingVisible:false,TruckOutVisible:false});this.getView().setModel(e,"TableVisibility");this.oRouter.attachRouteMatched(e=>{const t=e.getParameter("name");if(t!=="OperationalTat"){if(this._refreshInterval){clearInterval(this._refreshInterval);this._refreshInterval=null}}})},_onRouteMatched:function(e){var t=this.getView();t._bInitialClearDone=false;var a=t.byId("idPlantInputF4");if(a){a.setValue("")}this._openPlantFragment();this._fetchPlantDataAndAutoSelect()},_fetchPlantDataAndAutoSelect:function(){this._getPlantData().then(function(e){if(e?.results?.[0]?.F4PlantNav?.results?.length===1){this._handlePlantSelection(e.results[0].F4PlantNav.results[0].Werks);this._closePlantFragment()}else{this._setPlantModelToFragment(e)}}.bind(this)).catch(function(e){i.show("Error fetching plants: "+e)})},_getPlantData:function(){var e=this;return new Promise(function(t,a){var l=e.getView().getModel();var i=[new n("ProcessType",r.EQ,"X"),new n("Plant",r.EQ,"X"),new n("Vehtype",r.EQ,"X")];e.BusyDialog.open();l.read("/F4ParametersSet",{filters:i,urlParameters:{$expand:"F4DirectionNav,F4ProcessNav,F4PlantNav,F4TransporterNav,F4VehTypeNav"},success:function(a){e.BusyDialog.close();t(a)},error:function(t){e.BusyDialog.close();a(t)}})})},_openPlantFragment:function(){if(!this._pPlantFragment){this._pPlantFragment=s.load({id:this.getView().getId(),name:"ZGT_MM_INBOUND.Fragments.PlantSelection",controller:this}).then(function(e){this.getView().addDependent(e);e.open();return e}.bind(this))}else{this._pPlantFragment.then(function(e){e.open()})}},_setPlantModelToFragment:function(e){var a=new t(e);this.getView().setModel(a,"PlantF4")},onSelectPlantF4:function(){var e=this.byId("idPlantInputF4");var t=e.getValue();if(!t){i.show("Please select a plant");return}this._handlePlantSelection(t);this._closePlantFragment()},_handlePlantSelection:function(e){var t=this.byId("idPlantInputF4");t&&t.setValue(e);this._loadOperationalData(e,["TruckIn","PreQual"]);this._startAutoRefresh(e)},_closePlantFragment:function(){this._pPlantFragment&&this._pPlantFragment.then(function(e){e.close()})},onValueHelpPlantF4:function(e){oThat.vId=e.getSource().getId();e.getSource().setValueState("None");var t=this.getView().getModel("PlantF4");if(!t){i.show("No plant data available");return}if(!oThat.ValueHelp){oThat.ValueHelp=sap.ui.xmlfragment("ZGT_MM_INBOUND.Fragments.Plant",this);oThat.getView().setModel(t,"F4Model");oThat.getView().addDependent(oThat.ValueHelp)}oThat.ValueHelp.open()},onValueHelpConfirmPlant:function(e){var t=e.getParameter("selectedItem");if(t){var a=t.getDescription();var n=sap.ui.getCore().byId(oThat.vId);n.setValue(a)}if(oThat.ValueHelp){oThat.ValueHelp.destroy();oThat.ValueHelp=null}},onValueHelpSearch:function(e){var t=e.getParameter("value");var a=new n([new n("Werks",r.Contains,t),new n("Name1",r.Contains,t)]);var l=e.getSource().getBinding("items");l.filter([a])},_startAutoRefresh:function(e){var t=this;var a=[{filters:["TruckIn","PreQual"],visibleProps:["TruckInVisible","PreQualVisible"]},{filters:["Unloading","PreQualExp"],visibleProps:["UnloadingVisible","PreQualExpVisible"]},{filters:["Loading","TruckOut"],visibleProps:["LoadingVisible","TruckOutVisible"]}];var n=0;var r=this.getView().getModel("TableVisibility");function l(){var l=a[n];Object.keys(r.getData()).forEach(function(e){r.setProperty("/"+e,false)});l.visibleProps.forEach(function(e){r.setProperty("/"+e,true)});t._loadOperationalData(e,l.filters).finally(function(){n=(n+1)%a.length});i.show("Refreshing: "+l.filters.join(" & "))}l();if(t._refreshInterval)clearInterval(t._refreshInterval);t._refreshInterval=setInterval(l,45e3)},_loadOperationalData:function(e,i){var s=this.getOwnerComponent().getModel();var o=[new n("Check",r.EQ,"X"),new n("Werks",r.EQ,e)];if(Array.isArray(i)){i.forEach(function(e){o.push(new n(e,r.EQ,"X"))})}if(!oThat.BusyDialog)oThat.BusyDialog=new l;oThat.BusyDialog.open();return new Promise(function(e){s.read("/GetOppTatSet",{filters:o,urlParameters:{$expand:"GateEntryNav,LoadingNav,PreQualityExcepNav,TruckOutNav,PreQualityNav,UnloadingNav"},success:function(a){oThat.BusyDialog.close();if(a.results&&a.results.length>0){var n=a.results[0];var r=new t({GateEntry:n.GateEntryNav.results||[],Loading:n.LoadingNav.results||[],PreQualityExcep:n.PreQualityExcepNav.results||[],TruckOut:n.TruckOutNav.results||[],PreQuality:n.PreQualityNav.results||[],Unloading:n.UnloadingNav.results||[],TotalTruck:n.TotalTruck||0,TruckToday:n.TruckToday||0,Flags:{View:n.View,Edit:n.Edit},GateEntryCount:n.GateEntryNav?.results?.[0]?.Count||0,PreQualityCount:n.PreQualityNav?.results?.[0]?.Count||0,PreQualityExcepCount:n.PreQualityExcepNav?.results?.[0]?.Count||0,UnloadingCount:n.UnloadingNav?.results?.[0]?.Count||0,LoadingCount:n.LoadingNav?.results?.[0]?.Count||0,TruckOutCount:n.TruckOutNav?.results?.[0]?.Count||0});var l=Math.max(n.GateEntryNav?.results?.length||0,n.LoadingNav?.results?.length||0,n.PreQualityExcepNav?.results?.length||0,n.TruckOutNav?.results?.length||0,n.PreQualityNav?.results?.length||0,n.UnloadingNav?.results?.length||0);r.setSizeLimit(l);oThat.getView().setModel(r,"OperationalTATModel")}e()},error:function(t){oThat.BusyDialog.close();a.error(t.responseText);e()}})})},onNavBack:function(){oThat.oRouter.navTo("Inbound")},onExit:function(){if(this._refreshInterval){clearInterval(this._refreshInterval);this._refreshInterval=null}}})});
//# sourceMappingURL=Operational_Tat.controller.js.map