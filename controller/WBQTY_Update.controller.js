sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/BusyDialog","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/m/MessageToast","ZGT_MM_INBOUND/Util/Formatter","sap/ui/model/FilterOperator"],function(e,t,a,r,s,o,i,n){"use strict";return e.extend("ZGT_MM_INBOUND.controller.WBQTY_Update",{Formatter:i,onInit:function(){var e=this;e.BusyDialog=new a;e.oView=this.getView();e.oView.setModel(new r({cdate:new Date,weighBridge:"",uGrossWeight:"",uTareweight:"",uNetWeight:"",wbfDate:new Date(new Date-2*864e5),wbtDate:new Date}),"oWBModel");this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.getRoute("WBQTYUpdate").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){this.resourceText=this.getView().getModel("i18n").getResourceBundle()},onvalidateNumber:function(e){if(e){var t=e.getSource().getValue();t.match(/^\d+(\.\d+)?$/);e.getSource().setValue(t)}this.CalculateNetweight()},CalculateNetweight:function(){var e,t=this.getView().getModel("oWBModel"),a=t.getProperty("/uGrossWeight"),r=t.getProperty("/uTareweight");e=parseFloat(a)-parseFloat(r);t.setProperty("/uNetWeight",e.toFixed(3))},onResetPage:function(){var e=this.getView().getModel("oWBModel");e.setProperty("/weighBridge","");e.setProperty("/uGrossWeight","");e.setProperty("/uTareweight","");e.setProperty("/uNetWeight","");e.setProperty("/aWB_Data","");e.setProperty("/wbfDate",new Date(new Date-2*864e5));e.setProperty("/wbtDate",new Date)},onNavBack:function(){this.onResetPage();this.oRouter.navTo("Inbound")},_GetBatchCalls:function(e,t,a,r){var s=this,o=this.getOwnerComponent().getModel();var i=this.getView().getModel("oWBModel");sap.ui.core.BusyIndicator.show();o.read(e,{filters:t,urlParameters:{$expand:a},async:true,success:function(e,t){var a=e.results[0];if(r==="GETWeigh"){if(s.first){try{s.fragment=undefined;if(!s.fragment){s.fragment=sap.ui.xmlfragment("ZGT_MM_INBOUND.Fragments.OCR_WBList",s);s.oView.addDependent(s.fragment)}s.fragment.open()}catch(e){console.log(e)}}i.setProperty("/f4weighBridge",a.WbidF4Nav.results)}else if(r==="Head_Detail"){if(a.ReturnNav.results.length>0&&a.ReturnNav.results[0].Type==="W"){sap.m.MessageBox.warning(a.ReturnNav.results[0].Message,{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],emphasizedAction:sap.m.MessageBox.Action.OK,onClose:function(e){if(e==="YES"){i.setProperty("/aWB_Data",a.HeaderNav.results[0]);i.setProperty("/aItemNavData",a.ItemNav.results[0]);i.setProperty("/uGrossWeight",a.HeaderNav.results[0].Brgew);i.setProperty("/uTareweight",a.HeaderNav.results[0].Trwgt);i.setProperty("/uNetWeight",a.HeaderNav.results[0].Ntgew)}else{s.onResetPage()}}})}else{i.setProperty("/aWB_Data",a.HeaderNav.results[0]);i.setProperty("/aItemNavData",a.ItemNav.results[0]);i.setProperty("/uGrossWeight",a.HeaderNav.results[0].Brgew);i.setProperty("/uTareweight",a.HeaderNav.results[0].Trwgt);i.setProperty("/uNetWeight",a.HeaderNav.results[0].Ntgew)}}sap.ui.core.BusyIndicator.hide()},error:function(e){sap.ui.core.BusyIndicator.hide()}})},onValueHelpPress:function(e){var t=this.getView().getModel("oWBModel");if(e.sId==="valueHelpRequest"){this.first=true;t.setProperty("/wbfDate",new Date(new Date-2*864e5));t.setProperty("/wbtDate",new Date)}else{this.first=false}var a=t.getProperty("/wbfDate");var r=t.getProperty("/wbtDate");var s=new Date(a.toString().split("GMT ")[0]+" UTC ").toISOString().split(".")[0];var o=new Date(r.toString().split("GMT ")[0]+" UTC ").toISOString().split(".")[0];var i="/InputSet",n=[new sap.ui.model.Filter("Flag",sap.ui.model.FilterOperator.EQ,"WBIDF4"),new sap.ui.model.Filter("FromDate",sap.ui.model.FilterOperator.EQ,s),new sap.ui.model.Filter("ToDate",sap.ui.model.FilterOperator.EQ,o)],g="WbidF4Nav";this._GetBatchCalls(i,n,g,"GETWeigh")},fnSearchWb:function(e){var t=e.getParameter("value");if(t&&t.length>0){var a=new sap.ui.model.Filter("Wbid",sap.ui.model.FilterOperator.Contains,t);var r=new sap.ui.model.Filter("Delivery",sap.ui.model.FilterOperator.Contains,t);var o=new sap.ui.model.Filter("Vehno",sap.ui.model.FilterOperator.Contains,t);var i=new s([a,r,o])}var n=this.fragment.getContent()[2];var g=n.getBinding("items");g.filter(i)},onValueHelpConfirm:function(e){var t=this,a=this.getView().getModel("oWBModel");var r=e.oSource.getBindingContext("oWBModel").getObject();var s="/InputSet",o=[new sap.ui.model.Filter("Flag",sap.ui.model.FilterOperator.EQ,"GET"),new sap.ui.model.Filter("Wbid",sap.ui.model.FilterOperator.EQ,r.Wbid||"")],i="HeaderNav,ItemNav,ReturnNav";this._GetBatchCalls(s,o,i,"Head_Detail");a.setProperty("/weighBridge",r.Wbid);t.fragment.close()},onClosefragment:function(){this.fragment.close()},fnWBGetData:function(e){var t=e.oSource.getValue().trim();if(t.length===12){var a="/InputSet",r=[new sap.ui.model.Filter("Flag",sap.ui.model.FilterOperator.EQ,"GET"),new sap.ui.model.Filter("Wbid",sap.ui.model.FilterOperator.EQ,t||"")],s="HeaderNav,ItemNav,ReturnNav";this._GetBatchCalls(a,r,s,"Head_Detail")}},fnGetAttachDetails:function(){var e=this.getView().getModel("oWBModel");if(e.getProperty("/aWB_Data/Wbid")){var t="/sap/opu/odata/sap/ZGW_GT_MM_WB_MOBILITY_SRV/OcrImageSet(Flag='OCR',Wbid='"+e.getProperty("/aWB_Data/Wbid")+"')/$value";var a=encodeURI(t);var r=new sap.ui.core.HTML({});sap.m.URLHelper.redirect(a,true)}else{sap.m.MessageBox.warning(this.resourceText.getText("Mandatory"))}},onSaveData:function(){var e=this,a=true,r=this.getView().getModel("oWBModel"),s=r.getProperty("/aWB_Data"),o=r.getProperty("/uGrossWeight"),i=r.getProperty("/uTareweight"),n=r.getProperty("/uNetWeight");if(r.getProperty("/weighBridge").trim().length<=0){sap.m.MessageBox.warning(this.resourceText.getText("Mandatory"));a=false}else if(s.Brgew===o&&s.Trwgt===i&&s.Ntgew===n){sap.m.MessageBox.warning(this.resourceText.getText("noChangeMade"));a=false}else if(parseFloat(n)<0){sap.m.MessageBox.warning(this.resourceText.getText("NetweightcannotbeNeg"));a=false}if(a){t.show(e.resourceText.getText("ConfirmMsgTxt"),{icon:sap.m.MessageBox.Icon.INFORMATION,title:e.resourceText.getText("Confirm"),actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(t){if(t===sap.m.MessageBox.Action.YES){e.generatepayloadPost()}}})}},generatepayloadPost:function(){var e=this,t=this.getOwnerComponent().getModel(),r=this.getView().getModel("oWBModel");var s=r.getProperty("/aWB_Data"),o=r.getProperty("/aItemNavData");var i=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-ddT00:00:00"});var n=[{Wbid:s.Wbid||"",Werks:s.Werks||"",Brgew:r.getProperty("/uGrossWeight")||"",Trwgt:r.getProperty("/uTareweight")||"",Ntgew:r.getProperty("/uNetWeight").toString()||"",Uom:s.Uom||""}];e.BusyDialog=new a;e.BusyDialog.open();var g={d:{Flag:"SAVE",Wbid:r.getProperty("/weighBridge")||"",HeaderNav:n||"",ReturnNav:[]}};t.create("/InputSet",g,{success:function(t,a){var r=t;if(r.ReturnNav.results.length>0&&r.ReturnNav.results[0].Type==="E"){sap.m.MessageBox.error(r.ReturnNav.results[0].Message)}else{e.onResetPage();console.log(r);var s="";for(var o in t.ReturnNav.results){if(o==="0")s=t.ReturnNav.results[o].Message;else s+="\n"+t.ReturnNav.results[o].Message}sap.m.MessageBox.information(s)}e.BusyDialog.close()},error:function(t){e.BusyDialog.close();sap.m.MessageBox.error(t.message)}})}})});
//# sourceMappingURL=WBQTY_Update.controller.js.map